# Central Ring Project Context for Gemini CLI Agent

This document provides essential context for the Gemini CLI agent to understand the Central Ring project, its architecture, and common operational patterns.

## Project Overview
Central Ring is an application designed for managing "entities" with custom attributes. It features a React-based frontend and a Node.js/Express backend, leveraging Supabase for database and authentication (session management) and Resend for email-based OTP delivery.

## Key Technologies
- **Frontend:** React, Vite, `react-router-dom`, Axios
- **Backend:** Node.js, Express, TypeScript, Supabase SDK (`@supabase/supabase-js`), Resend SDK (`resend`), CORS, Dotenv
- **Database/Auth:** Supabase (PostgreSQL, Authentication, RLS)
- **Email Service:** Resend
- **Deployment:** Vercel (Frontend and Backend as Serverless Functions)

## Authentication Flow (Custom OTP)
The authentication flow is a custom OTP (One-Time Password) system, *not* relying on Supabase's built-in OTP email sending.
1.  **`POST /auth/send-otp` (Backend):**
    *   Generates a 6-digit OTP.
    *   Stores the `email`, `otp`, and `expires_at` in a **Supabase table named `otps`**.
    *   Sends the OTP to the user's email via **Resend**.
2.  **`POST /auth/verify-otp` (Backend):**
    *   Retrieves the OTP from the `otps` table based on the provided `email`.
    *   Validates the OTP and its expiry against the stored record.
    *   **Crucially:** If the custom OTP is valid, it then uses Supabase's `auth.signInWithPassword` (for existing users) or `auth.signUp` (for new users) with a **predefined dummy password** to establish a Supabase session. This means Supabase handles the session, but the custom OTP flow controls access.
    *   The `otps` table entry is deleted upon successful verification.

**Important Note:** Do NOT attempt to use `supabaseAuth.auth.verifyOtp` directly with the custom-generated OTP, as it expects OTPs generated by Supabase itself.

## Database Schema (Key Tables)
-   **`gemini_cli_entity_types`**: Stores definitions of entity types (e.g., 'Car', 'Product').
    -   `id` (TEXT, PK)
    -   `name` (TEXT)
    -   `description` (TEXT)
    -   `predefined_attributes` (JSONB)
-   **`gemini_cli_entities`**: Stores actual entity instances.
    -   `id` (TEXT, PK)
    -   `type_id` (TEXT, FK to `gemini_cli_entity_types.id`)
    -   `name` (TEXT)
    -   `attributes` (JSONB) - Stores actual attribute values for an entity instance.
    -   `owner_id` (TEXT, FK to Supabase `auth.users.id`)
    -   `created_at` (TIMESTAMP WITH TIME ZONE)
    -   `updated_at` (TIMESTAMP WITH TIME ZONE)
    -   `missing_info_attributes` (TEXT[]) - Array of attribute names that are required but missing.
    -   `requested_by_users` (TEXT[]) - Array of user IDs who have requested information for this entity.
    -   `interaction_log` (JSONB[]) - Array of interaction events (e.g., `attribute_requested`).
-   **`otps`**: Stores custom OTPs for verification.
    -   `email` (TEXT, PK)
    -   `otp` (TEXT)
    -   `expires_at` (TIMESTAMP WITH TIME ZONE)

## Deployment Considerations (Vercel)
-   **Backend:** Deployed as a Node.js serverless function. Environment variables (e.g., `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `RESEND_API_KEY`, `YOUR_RESEND_EMAIL_FROM`) must be set in Vercel project settings.
-   **Frontend:** Deployed as a static site. `VITE_API_BASE_URL` must be set in Vercel project settings to point to the deployed backend URL.
-   **SPA Routing:** Frontend uses `react-router-dom`. A `vercel.json` in the `frontend` directory ensures all routes are rewritten to `index.html` for proper client-side routing.
-   **Statelessness:** Backend serverless functions are stateless. Avoid in-memory storage for persistent data (e.g., OTPs, user sessions).

## Common Issues & Debugging
-   **CORS Errors (Preflight 404/500):** Ensure `OPTIONS` handlers are explicitly defined for routes that receive `POST` requests, or that `cors()` middleware is correctly applied.
-   **"Invalid Header Value" for Supabase Keys:** This usually means hidden newline characters or whitespace in environment variables. Ensure keys are `.trim()`med and `replace(/\n/g, '')` if necessary.
-   **OTP Issues:**
    *   Verify `otps` table schema and RLS policies in Supabase.
    *   Check `expires_at` logic to ensure it aligns with expected expiry.
    *   Confirm Resend API key and "From" email are correct and verified in Resend.
-   **Frontend Routing (Direct URL Access):** If direct URL access to sub-routes fails, check `frontend/vercel.json` for correct rewrite rules.
-   **Missing Environment Variables:** Always check Vercel environment variables first if a deployed app fails with "variable not set" errors.

## Interaction Guidelines
-   When asked to modify authentication, always confirm if the custom OTP flow (Resend + `otps` table) should be maintained.
-   Prioritize database-backed solutions over in-memory storage for persistent data.
-   When debugging deployment issues, always ask for Vercel logs.
-   Be mindful of RLS policies in Supabase when performing database operations. If an operation fails, consider if the `supabaseServiceRole` client should be used instead of the `supabaseAuth` client.

